# .github/workflows/deploy.yml (수정 완료된 버전)
name: Deploy to NCP
on:
  push:
    branches: [ "master" ]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v3
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      - name: Setup SSH key
        run: |
          set -x
          mkdir -p ~/.ssh
          echo "${{ secrets.BASTION_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.BASTION_HOST }} >> ~/.ssh/known_hosts || echo "ssh-keyscan failed"
          ssh -o StrictHostKeyChecking=no ${{ secrets.BASTION_USER }}@${{ secrets.BASTION_HOST }} "echo SSH connection success" || echo "SSH connection failed"

      # --- SpringBoot1 폴더 안에서 실행 ---
      - name: Make mvnw executable
        run: chmod +x ./mvnw
        working-directory: ./SpringBoot1
      - name: Build Spring Boot app with Maven
        run: |
          set -x
          ./mvnw clean package
        working-directory: ./SpringBoot1
      - name: List JARs built (debug)
        run: |
          set -x
          ls -lh target/
        working-directory: ./SpringBoot1
      - name: Copy JAR to bastion server
        run: |
          set -x
          echo "Copying JAR to bastion server..."
          scp target/*SNAPSHOT.jar ${{ secrets.BASTION_USER }}@${{ secrets.BASTION_HOST }}:/tmp/app.jar
        working-directory: ./SpringBoot1
      # --- --------------------------- ---

      - name: SSH into bastion and move JAR to private server
        run: |
          set -x
          echo "SSH into bastion host and run commands..."
          ssh ${{ secrets.BASTION_USER }}@${{ secrets.BASTION_HOST }} << 'EOF'
            echo "Copying app.jar to private server..."
            scp /tmp/app.jar root@10.1.2.6:/root/app.jar
            echo "Running deploy.sh on private server..."
            ssh root@10.1.2.6 'bash /root/deploy.sh'
          EOF